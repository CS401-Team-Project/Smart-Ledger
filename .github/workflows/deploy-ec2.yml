name: Deploy-to-EC2

# Trigger deployment only on push to main branch
on:
  push:
    branches:
      - main

jobs:
  build:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
          submodules: 'recursive'
          #      - name: Docker Deployment
          #        uses: wshihadeh/docker-deployment-action@master
          #        with:
          #          remote_docker_host: ubuntu@sl.absolutzero.org
          #          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          #          ssh_public_key: ${{ secrets.SSH_KNOWN_HOSTS }}
          #          deployment_mode: docker-compose
          #          copy_stack_file: false
          #          deploy_path: /home/ubuntu/smart-ledger
          #          stack_file_name: docker-compose.yml
          #          pull_images_first: true
          #          keep_files: 3
          #          args: --verbose up -d
      # Step 2: Add SSH credentials to your GitHub CI/CD instance
      - name: Add SSH Credentials
        uses: shimataro/ssh-key-action@v2.3.1
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }} # required, this will be used when transferring files to your deploy targets
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }} # required, should match up with your deploy targets (see below)
      # Step 3: Deploy!
      - name: Deploy to AWS
        uses: JorgenVatle/docker-compose-deploy@v1.0
        with:
          deploy_targets: 'sl.absolutzero.org' # required, comma separated list of servers to deploy to.
          ssh_user: 'ubuntu' # optional, user to connect to deploy targets with. Defaults to 'root'
          compose_file: 'docker-compose.yml' # optional, path/filename of your docker-compose file. Defaults to 'docker-compose.yml'
          validate_container: 'smart-ledger-client' # optional, validate that the given container name is running. Otherwise, throw an error. Defaults to 'app'